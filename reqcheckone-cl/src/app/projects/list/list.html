<div class="projects-wrapper">
  <!-- ================= HEADER ================= -->
  <div class="projects-toolbar-modern">
    <!-- Left: Título y subtítulo -->
    <div class="toolbar-left-modern">
      <h2>Mis Proyectos</h2>
      <span class="subtitle-modern">Gestiona, organiza y supervisa tus proyectos activos</span>
    </div>

    <!-- Right: Acciones -->
    <div class="toolbar-right-modern">
      <!-- Buscador -->
      <div class="search-command-modern">
        <i class="bi bi-search"></i>
        <input
          type="text"
          placeholder="Buscar proyectos..."
          [(ngModel)]="searchTerm"
          (input)="filterProjects()"
        />
      </div>

      <!-- Toggle Vista -->
      <button
        class="view-switch-modern"
        (click)="toggleView()"
        [title]="viewMode === 'cards' ? 'Ver lista' : 'Ver tarjetas'"
      >
        <i class="bi" [ngClass]="viewMode === 'cards' ? 'bi-list' : 'bi-grid'"></i>
      </button>

      <!-- Crear proyecto -->
      <button class="btn-primary-modern-modern" (click)="createProject()">
        <i class="bi bi-plus-lg"></i> Nuevo Proyecto
      </button>
    </div>
  </div>

  <!-- ================= STATES ================= -->

  <div *ngIf="loading" class="state-box loading">
    <i class="bi bi-arrow-repeat spin"></i>
    Cargando proyectos...
  </div>

  <div *ngIf="error" class="state-box error">
    <i class="bi bi-exclamation-circle"></i>
    {{ error }}
  </div>

  <!-- ================= CARDS MODERNAS ================= -->

  <div class="cards-grid-modern" *ngIf="!loading && !error && viewMode === 'cards'">
    <div
      class="project-card-modern"
      *ngFor="let project of filteredProjects"
      (click)="viewProject(project.id)"
    >
      <!-- Barra de estado lateral -->
      <div
        class="accent-bar-modern"
        [ngClass]="project.status === 'activo' ? 'active' : 'done'"
      ></div>

      <!-- Contenido -->
      <div class="card-content-modern">
        <!-- Header: Nombre y Chip Estado -->
        <div class="card-header-modern">
          <h4 class="project-title">{{ project.name }}</h4>
          <span
            class="status-chip-modern"
            [ngClass]="project.status === 'activo' ? 'chip-active' : 'chip-done'"
          >
            {{ project.status || 'Sin estado' }}
          </span>
        </div>

        <!-- Descripción -->
        <p class="description-modern">{{ truncateText(project.description, 130) }}</p>

        <!-- Footer: Avatares y Deadline -->
        <div class="card-footer-modern">
          <div class="avatars-modern">
            <span
              *ngFor="let c of project.collaborators"
              class="avatar-modern"
              [title]="c.username + ' (' + c.role + ')'"
              (click)="$event.stopPropagation()"
            >
              {{ c.username.charAt(0) | uppercase }}
            </span>
            <span *ngIf="!project.collaborators?.length" class="no-collaborators">—</span>
          </div>

          <div class="deadline-modern" *ngIf="project.deadline">
            <i class="bi bi-calendar-event"></i> {{ project.deadline }}
          </div>
        </div>

        <!-- Acciones -->
        <div class="card-actions-modern">
          <button
            class="btn-danger-modern"
            (click)="openDeleteModal(project); $event.stopPropagation()"
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= LIST VIEW MODERNA ================= -->

  <div *ngIf="!loading && !error && viewMode === 'list'" class="table-modern-wrapper">
    <table class="table-modern">
      <thead>
        <tr>
          <th>Proyecto</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Colaboradores</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let project of filteredProjects" class="table-row-modern">
          <!-- Nombre + Descripción -->
          <td class="project-name-modern">
            <div class="project-title">{{ project.name }}</div>
            <div class="project-desc">
              {{ truncateText(project.description, 60) }}
            </div>
          </td>

          <!-- Estado -->
          <td>
            <span
              class="status-chip-modern"
              [ngClass]="project.status === 'activo' ? 'chip-active' : 'chip-done'"
            >
              {{ project.status || '—' }}
            </span>
          </td>

          <!-- Fecha -->
          <td>{{ project.deadline || '—' }}</td>

          <!-- Colaboradores -->
          <td>
            <div class="avatars-modern">
              <span
                *ngFor="let c of project.collaborators"
                class="avatar-modern small"
                [title]="c.username + ' (' + c.role + ')'"
              >
                {{ c.username.charAt(0) | uppercase }}
              </span>
              <span *ngIf="!project.collaborators?.length" class="no-collaborators">—</span>
            </div>
          </td>

          <!-- Acciones -->
          <td class="actions-modern">
            <button class="btn-danger-modern" (click)="openDeleteModal(project)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ================= MODAL DELETE MODERNO ================= -->
  <div class="modal fade modern-modal" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content-modern">
        <div class="modal-body-modern text-center">
          <!-- Icono de alerta -->
          <div class="icon-danger-modern mb-3">
            <i class="bi bi-trash-fill"></i>
          </div>

          <!-- Título -->
          <h4 class="modal-title-modern mb-2">Eliminar Proyecto</h4>

          <!-- Mensaje -->
          <p class="modal-text-modern mb-4">
            ¿Seguro que deseas eliminar <strong>{{ projectToDelete?.name }}</strong
            >?
            <br />
            Esta acción no se puede deshacer.
          </p>

          <!-- Acciones -->
          <div class="modal-actions-modern d-flex justify-content-center gap-3">
            <button class="btn-secondary-modern" (click)="cancelDelete()">Cancelar</button>
            <button class="btn-danger-modern" (click)="confirmDelete()">Eliminar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= MODAL NO OWNER MODERNO ================= -->
  <div class="modal fade modern-modal" id="notOwnerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content-modern">
        <div class="modal-body-modern text-center">
          <!-- Icono de advertencia -->
          <div class="icon-warning-modern mb-3">
            <i class="bi bi-shield-exclamation-fill"></i>
          </div>

          <!-- Título -->
          <h4 class="modal-title-modern mb-2">Acción no permitida</h4>

          <!-- Mensaje -->
          <p class="modal-text-modern mb-4">Solo el dueño puede eliminar este proyecto.</p>

          <!-- Acción -->
          <div class="modal-actions-modern d-flex justify-content-center">
            <button class="btn-primary-modern" data-bs-dismiss="modal">Entendido</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
