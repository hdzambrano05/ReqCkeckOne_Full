<div class="history-container">
  <h2>Historial de Cambios</h2>

  <!-- Loading -->
  <div *ngIf="loading" class="loading d-flex align-items-center">
    <div class="spinner-border text-primary me-2" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    Cargando historial...
  </div>

  <!-- Historial agrupado por proyecto -->
  <div *ngIf="!loading && groupedHistory.length > 0">
    <div *ngFor="let project of groupedHistory" class="project-group mb-3">
      <!-- Nombre del proyecto con toggle -->
      <h3
        (click)="toggleProject(project)"
        class="project-title p-2 rounded text-primary"
        style="cursor: pointer; user-select: none"
      >
        <i
          [ngClass]="
            project.expanded ? 'bi bi-caret-down-fill me-2' : 'bi bi-caret-right-fill me-2'
          "
        ></i>
        {{ project.projectName }}
      </h3>

      <!-- Tabla de requisitos solo si expanded -->
      <div *ngIf="project.expanded" class="table-responsive mt-2">
        <table class="history-table table align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th>Requisito</th>
              <th>Versión</th>
              <th>Cambio</th>
              <th>Modificado por</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let item of project.requirements"
              [ngClass]="{
                'table-danger': item.currentStatus === 'eliminado',
                'table-info': item.currentStatus === 'modificado' || item.currentStatus === 'activo'
              }"
            >
              <td data-label="Requisito">{{ item.requirement?.title || '—' }}</td>
              <td data-label="Versión">
                <span class="badge bg-secondary">{{ item.version }}</span>
              </td>
              <td data-label="Cambio">{{ item.text }}</td>
              <td data-label="Modificado por">{{ item.changer?.username || 'Desconocido' }}</td>
              <td data-label="Fecha">{{ item.updated_at | date : 'short' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sin historial -->
  <div *ngIf="!loading && groupedHistory.length === 0" class="no-data text-muted">
    <i class="bi bi-info-circle me-2"></i> No hay cambios registrados.
  </div>
</div>
