<div
  class="requirement-container container py-4"
  *ngIf="!loading && requirement as req; else loadingState"
>
  <!-- Botón volver -->
  <button class="btn btn-outline-primary rounded-pill px-4 mb-4" (click)="goBack()">
    <i class="bi bi-arrow-left"></i> Volver al proyecto
  </button>

  <!-- HEADER PRINCIPAL -->
  <div class="card shadow border-0 mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
          <h2 class="fw-bold text-primary mb-2">
            <i class="bi bi-file-earmark-text"></i>
            {{ req.title }}
          </h2>

          <div class="d-flex flex-wrap gap-2">
            <span
              class="badge px-3 py-2"
              [ngClass]="{
                'bg-success': req.status === 'aprobado',
                'bg-warning text-dark': req.status === 'pendiente',
                'bg-danger': req.status === 'rechazado',
                'bg-secondary': !req.status,
              }"
            >
              Estado: {{ req.status || 'N/A' }}
            </span>

            <span class="badge bg-info text-dark px-3 py-2">
              Prioridad: {{ req.priority || 'N/A' }}
            </span>

            <span class="badge bg-dark px-3 py-2"> Versión: {{ req.version || '1.0' }} </span>
          </div>
        </div>

        <!-- Score global -->
        <div *ngIf="analysis?.promedio_cumplimiento != null" class="text-center">
          <h6 class="text-muted mb-1">Cumplimiento Global</h6>
          <h3 class="fw-bold text-success">{{ analysis?.promedio_cumplimiento }}%</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- DESCRIPCIÓN -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="text-secondary mb-3"><i class="bi bi-journal-text"></i> Descripción</h5>

      <p class="text-muted mb-3">
        {{ req.text || 'No se ha definido descripción.' }}
      </p>

      <div *ngIf="req.context" class="alert alert-light border-start border-4 border-primary">
        <strong>Contexto:</strong>
        <div class="mt-1 text-muted">
          {{ req.context }}
        </div>
      </div>
    </div>
  </div>

  <!-- ================= ANALISIS ================= -->
  <div *ngIf="analysis as a" class="analysis-section mt-5">
    <h4 class="fw-bold text-success mb-4">
      <i class="bi bi-bar-chart-line"></i> Análisis Inteligente del Requisito
    </h4>

    <!-- Resultado general -->
    <div class="card border-success border-opacity-25 shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div>
            <h6 class="text-muted mb-1">Resultado General</h6>
            <p class="fw-semibold mb-0">
              {{ a?.refined_requirement?.estado | titlecase }}
            </p>
            <small class="text-muted">
              {{ a?.refined_requirement?.mensaje }}
            </small>
          </div>

          <!-- Barra de progreso -->
          <div class="w-50">
            <div class="progress" style="height: 10px">
              <div
                class="progress-bar bg-success"
                role="progressbar"
                [style.width.%]="a?.promedio_cumplimiento || 0"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ANALISIS POR AGENTES -->
    <h5 class="text-primary fw-semibold mb-3">
      <i class="bi bi-people"></i> Evaluación por Agentes
    </h5>

    <div class="row g-4">
      <div *ngFor="let agent of a?.agents | keyvalue" class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold text-primary mb-0">
                <i class="bi bi-person-badge"></i>
                {{ agent?.value?.role }}
              </h6>

              <span class="badge bg-success px-3 py-2"> {{ agent?.value?.porcentaje }}% </span>
            </div>

            <ul class="list-group list-group-flush" *ngIf="agent?.value?.analysis">
              <li class="list-group-item" *ngFor="let item of agent?.value?.analysis | keyvalue">
                <div class="d-flex justify-content-between">
                  <span class="fw-semibold">
                    {{ item.key | titlecase }}
                  </span>
                  <span class="text-muted">
                    {{ item.value }}
                  </span>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= LOADING ================= -->
<ng-template #loadingState>
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-muted">Cargando análisis del requisito...</p>
  </div>
</ng-template>
