<!-- Flecha para regresar -->
<button
  class="btn btn-outline-secondary btn-sm mb-3 d-flex align-items-center gap-1"
  (click)="goBack()"
>
  <i class="bi bi-arrow-left"></i> Regresar
</button>

<div class="create-requirement container py-4">
  <div class="row g-4">
    <!-- Formulario -->
    <div class="col-lg-6">
      <form
        [formGroup]="form"
        (ngSubmit)="analyzeRequirement()"
        class="card p-4 shadow-sm rounded-4"
      >
        <h3 class="mb-4 text-primary">Crear Requisito</h3>

        <div class="mb-3">
          <label class="form-label">Proyecto:</label>
          <input class="form-control" [value]="projectName" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label">Título:</label>
          <input class="form-control" formControlName="title" placeholder="Título del requisito" />
        </div>

        <div class="mb-3">
          <label class="form-label">Requisito:</label>
          <textarea
            class="form-control"
            formControlName="text"
            rows="3"
            placeholder="Describe el requisito"
          ></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Contexto:</label>
          <textarea
            class="form-control"
            formControlName="context"
            rows="2"
            placeholder="Opcional"
          ></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Estado:</label>
          <select class="form-select" formControlName="status">
            <option value="draft">Draft</option>
            <option value="finalizado">Finalizado</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Prioridad:</label>
          <input class="form-control" [formControl]="priorityControl" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label">Fecha límite:</label>
          <input class="form-control" type="date" formControlName="due_date" />
        </div>

        <div class="mb-3">
          <label class="form-label">Versión:</label>
          <input class="form-control" type="number" formControlName="version" />
        </div>

        <div class="mb-3">
          <label class="form-label">Creado por:</label>
          <input class="form-control" [formControl]="createdByControl" readonly />
        </div>

        <button type="submit" class="btn btn-primary w-100" [disabled]="loadingAnalysis">
          <span *ngIf="!loadingAnalysis">Analizar Requisito</span>
          <span *ngIf="loadingAnalysis" class="spinner-border spinner-border-sm"></span>
        </button>
      </form>
    </div>

    <!-- Panel de atributos -->
    <div class="col-lg-6">
      <div class="card p-4 shadow-sm rounded-4">
        <h3 class="mb-4 text-success">Atributos del requisito</h3>

        <!-- Barras -->
        <div *ngFor="let attr of attributes" class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span
              class="fw-semibold"
              style="cursor: help"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              [attr.title]="attributeDescriptions[attr.name]"
            >
              {{ attr.name }}
              <i class="bi bi-info-circle text-secondary ms-1"></i>
            </span>
            <span>{{ attr.value }}%</span>
          </div>
          <div class="progress rounded-pill" style="height: 18px">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              [style.width.%]="attr.value"
              [ngClass]="{
                'bg-success': attr.value >= 80,
                'bg-warning': attr.value >= 50 && attr.value < 80,
                'bg-danger': attr.value < 50
              }"
            ></div>
          </div>

          <!-- sugerencias -->
          <div *ngIf="attributeSuggestions[attr.name]?.length && attr.value <= 60" class="mt-2">
            <small class="text-warning fw-semibold">Sugerencias:</small>
            <ul class="mb-0" style="font-size: 0.9em">
              <li *ngFor="let s of attributeSuggestions[attr.name]" class="text-muted">{{ s }}</li>
            </ul>
          </div>
        </div>

        <h5 class="mt-4">
          Porcentaje de calidad del requisto (0% - 100%):
          <span class="text-primary">{{ getTotalProgress() }}%</span>
        </h5>

        <!-- === Sección dinámica según resultado === -->
        <ng-container *ngIf="analysis?.refined_requirement as rr">
          <!-- Caso < 30% -->
          <div *ngIf="getTotalProgress() < 30" class="mt-4 alert alert-danger rounded-3">
            <h6>Requisito refinado sugerido:</h6>
            <pre class="bg-light p-3 rounded">{{ rr.requisito_refinado_final || 'No disponible' }}</pre>
            <button class="btn btn-outline-primary w-100 mt-2" (click)="copyRefinedToText()">
              <i class="bi bi-clipboard"></i> Copiar al campo de texto
            </button>
          </div>

          <!-- Caso 30 - 59 -->
          <div *ngIf="getTotalProgress() >= 30 && getTotalProgress() < 60" class="mt-4 alert alert-warning rounded-3">
            <h6>Debe mejorar el requisito:</h6>
            <p class="mb-2">
              Siga las sugerencias mostradas para obtener un requisito de mejor calidad.
            </p>
          </div>

          <!-- Caso >= 60 -->
          <div *ngIf="getTotalProgress() >= 60" class="mt-4 alert alert-success rounded-3">
            <p class="mb-2">El requisito cumple con los estándares mínimos de calidad.</p>
            <button
              class="btn btn-success w-100"
              (click)="saveRequirement()"
              [disabled]="!canSave"
            >
              <i class="bi bi-save"></i> Guardar Requisito
            </button>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Modal notificación -->
  <div *ngIf="showModal" class="modal-backdrop">
    <div
      class="modal-content"
      [ngClass]="{
        'modal-success': modalType === 'success',
        'modal-error': modalType === 'error',
        'modal-info': modalType === 'info'
      }"
    >
      <p>{{ modalMessage }}</p>
      <button (click)="closeModal()">Cerrar</button>
    </div>
  </div>

  <!-- Modal de carga -->
  <div *ngIf="loadingAnalysis" class="modal-backdrop modal-loading">
    <div class="modal-content">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Analizando requisito...</p>
    </div>
  </div>
</div>
