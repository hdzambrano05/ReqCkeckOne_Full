<div class="container py-4">
  <!-- Botón Regresar -->
  <button
    class="btn btn-outline-secondary btn-sm mb-3 d-flex align-items-center gap-1"
    (click)="goBack()"
  >
    <i class="bi bi-arrow-left"></i> Regresar
  </button>

  <div class="row g-4">
    <!-- FORMULARIO -->
    <div class="col-lg-6">
      <form [formGroup]="form" class="card p-4 shadow-sm rounded-4">
        <h3 class="mb-4 text-primary">Editar Requisito Funcional</h3>

        <!-- Proyecto -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Proyecto:</label>
          <input class="form-control" [value]="projectName" readonly />
        </div>

        <!-- Título -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Título:</label>
          <input class="form-control" formControlName="title" />
        </div>

        <!-- Descripción -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Descripción:</label>
          <textarea
            class="form-control"
            formControlName="text"
            rows="3"
            (click)="enableAnalyze()"
          ></textarea>
        </div>

        <!-- Contexto -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Contexto:</label>
          <textarea class="form-control" formControlName="context" rows="2"></textarea>
        </div>

        <!-- Estado -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Estado:</label>
          <select class="form-select" formControlName="status">
            <option value="draft">Borrador</option>
            <option value="reviewed">Revisado</option>
            <option value="accepted">Aceptado</option>
            <option value="rejected">Rechazado</option>
          </select>
        </div>

        <!-- Prioridad solo lectura -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Prioridad (PO):</label>
          <input class="form-control fw-bold" formControlName="priority" readonly />
        </div>

        <!-- Fecha límite -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Fecha límite:</label>
          <input class="form-control" type="date" formControlName="due_date" />
        </div>

        <!-- Versión -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Versión:</label>
          <input class="form-control" type="number" formControlName="version" />
        </div>

        <!-- Botones -->
        <div class="d-grid gap-2">
          <button
            type="button"
            class="btn btn-warning"
            [disabled]="!canAnalyze || loadingAnalysis"
            (click)="analyzeRequirement()"
          >
            <span *ngIf="!loadingAnalysis">Analizar Requisito</span>
            <span *ngIf="loadingAnalysis" class="spinner-border spinner-border-sm"></span>
          </button>
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="!canSave"
            (click)="updateRequirement()"
          >
            Actualizar
          </button>
        </div>
      </form>
    </div>

    <!-- BARRAS DE ATRIBUTOS -->
    <div class="col-lg-6" *ngIf="analysis">
      <div class="card p-4 shadow-sm rounded-4">
        <h3 class="text-success mb-3">Atributos del Requisito</h3>

        <div *ngFor="let attr of attributes" class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="fw-semibold" [title]="attr.description" style="cursor: help">{{
              attr.name
            }}</span>
            <span>{{ attr.value }}%</span>
          </div>
          <div class="progress rounded-pill" style="height: 20px">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              [style.width.%]="attr.value"
              [ngClass]="{
                'bg-success': attr.value >= 80,
                'bg-warning': attr.value >= 50 && attr.value < 80,
                'bg-danger': attr.value < 50
              }"
            ></div>
          </div>
          <small class="text-muted d-block mt-1" style="font-size: 0.85rem">{{
            attr.description
          }}</small>
        </div>

        <!-- Sugerencias de mejora -->
        <div
          *ngIf="analysis?.refined_requirement?.sugerencias?.length"
          class="alert alert-warning d-flex flex-column gap-2 mt-3 rounded-4 shadow-sm"
        >
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-lightbulb-fill fs-4"></i>
            <strong>Sugerencias de mejora:</strong>
          </div>
          <ul class="mb-0 mt-2 ps-4">
            <li *ngFor="let s of analysis.refined_requirement.sugerencias">{{ s }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CENTRALIZADO -->
  <div
    *ngIf="modalState.show"
    class="modal-backdrop fade show"
    (click)="modalState.type !== 'loading' ? closeModal() : null"
    [class.backdrop-clickable]="modalState.type !== 'loading'"
  ></div>

  <div
    *ngIf="modalState.show"
    class="modal d-block"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="'modal-title-' + modalState.type"
    tabindex="-1"
  >
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content shadow-3d rounded-3">
        <!-- Header con diseño premium -->
        <div
          class="modal-header d-flex flex-column align-items-center justify-content-center position-relative pt-4 pb-3"
          [ngClass]="{
            'modal-success': modalState.type === 'success',
            'modal-error': modalState.type === 'error',
            'modal-info': modalState.type === 'info',
            'modal-loading': modalState.type === 'loading'
          }"
        >
          <!-- Icono circular con fondo -->
          <div class="modal-icon-container mb-3">
            <i
              class="modal-icon"
              [ngClass]="{
                'bi bi-arrow-clockwise': modalState.type === 'loading',
                'bi bi-check-lg': modalState.type === 'success',
                'bi bi-x-lg': modalState.type === 'error',
                'bi bi-info-lg': modalState.type === 'info'
              }"
            ></i>
          </div>

          <!-- Título con tipografía mejorada -->
          <h5 class="modal-title mb-0 fw-bold text-center" [id]="'modal-title-' + modalState.type">
            {{
              modalState.type === 'loading'
                ? 'Procesando'
                : modalState.type === 'success'
                ? 'Operación Exitosa'
                : modalState.type === 'error'
                ? 'Ha Ocurrido un Error'
                : 'Información'
            }}
          </h5>

          <!-- Línea decorativa -->
          <div class="modal-divider mt-3"></div>
        </div>

        <!-- Cuerpo del modal -->
        <div class="modal-body text-center px-4 py-4">
          <ng-container *ngIf="modalState.type === 'loading'">
            <div class="spinner-container mb-4">
              <div class="spinner-border-slim" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            <p class="mb-0 fw-medium text-dark lh-base fs-6">
              {{ modalState.message }}
            </p>
          </ng-container>

          <ng-container *ngIf="modalState.type !== 'loading'">
            <p class="mb-0 fw-medium text-muted lh-base fs-6 px-2">
              {{ modalState.message }}
            </p>
          </ng-container>
        </div>

        <!-- Footer mejorado -->
        <div
          class="modal-footer justify-content-center border-0 pt-0 pb-4"
          *ngIf="modalState.type !== 'loading'"
        >
          <button
            type="button"
            class="btn btn-primary px-4 py-2 fw-semibold rounded-2 btn-elegant"
            (click)="closeModal()"
          >
            <span class="btn-content"> <i class="bi bi-check-lg me-2"></i> Continuar </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
